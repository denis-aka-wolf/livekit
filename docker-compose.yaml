version: '3.8'

services:
  redis:
    image: redis:7-alpine
    network_mode: host
    restart: always
    volumes:
      - redis_data:/data

  livekit:
    image: livekit/livekit-server:latest
    network_mode: host
    restart: always
    depends_on:
      - redis
    env_file:
      - .env
    environment:
      # Установите свои ключи в переменных окружения
      # LIVEKIT_KEYS: "your_api_key: your_api_secret"
      LIVEKIT_KEYS: "${LIVEKIT_API_KEY:-YOUR_API_KEY_HERE}:${LIVEKIT_API_SECRET:-YOUR_API_SECRET_HERE}"
      LIVEKIT_REDIS_ADDRESS: "localhost:6379"
      LIVEKIT_DEV: "true"

  sip:
    image: livekit/sip:latest
    network_mode: host
    restart: always
    env_file:
      - .env
    environment:
      SIP_CONFIG_BODY: |
        api_key: '${LIVEKIT_API_KEY:-YOUR_API_KEY_HERE}'
        api_secret: '${LIVEKIT_API_SECRET:-YOUR_API_SECRET_HERE}'
        ws_url: 'ws://localhost:7880'
        redis:
          address: 'localhost:6379'
        sip_port: 5060
        udp_port: 5060
        rtp_port_range: 10000-20000
        logging:
          level: info
          
  my-agent:
    image: python:3.12-slim
    volumes:
      - ./agent:/app
    working_dir: /app
    # network_mode: host → используем ту же сеть что и остальные сервисы
    restart: always
    env_file:
      - .env
    environment:
      LIVEKIT_URL: "ws://localhost:7880"  # Изменено на localhost для соответствия другим сервисам
      LIVEKIT_API_KEY: "${LIVEKIT_API_KEY:-YOUR_API_KEY_HERE}"
      LIVEKIT_API_SECRET: "${LIVEKIT_API_SECRET:-YOUR_API_SECRET_HERE}"
      SIP_OUTBOUND_TRUNK_TEST_ID: "${SIP_OUTBOUND_TRUNK_TEST_ID:-YOUR_TRUNK_ID_HERE}"
    command: >
      sh -c "
        python -m venv /opt/venv && \
        /opt/venv/bin/pip install --upgrade pip && \
        /opt/venv/bin/pip install livekit-agents livekit-api python-dotenv && \
        /opt/venv/bin/python -u agent.py dev
      "
    depends_on:
    - livekit


volumes:
  redis_data: