# Архитектура агента Elaina Inbound (LiveKit)

## Обзор

Данная архитектура представляет собой модульное разделение функциональности агента Elaina Inbound, предназначенного для обработки входящих SIP-вызовов в LiveKit. Архитектура разработана для обеспечения лучшей читаемости, поддержки и тестируемости кода.

## Структура проекта

```
agent/
├── elaina-inbound-mango.py          # Главный файл агента (только entrypoint)
├── elaina-inbound-mango.md          # Файл промпта
├── __init__.py                      # Инициализация пакета
└── modules/                         # Директория с модулями
    ├── __init__.py                  # Инициализация пакета модулей
    ├── agent_core.py                # Логика агента (InboundAgent)
    ├── config_manager.py            # Управление конфигурацией и переменными окружения
    ├── prompt_processor.py          # Обработка промптов и шаблонов
    ├── call_controller.py           # Управление вызовами (hangup, transfer, etc.)
    ├── sip_data_handler.py          # Обработка данных SIP-вызовов
    └── media_config.py              # Настройка параметров STT, TTS, LLM
```

## Описание модулей

### 1. agent/modules/agent_core.py
Содержит класс `InboundAgent` с основной логикой агента:
- Идентификация клиентов по номеру телефона
- Проверка фраз прощания
- Обработка инструментов (transfer_call, end_call, look_up_availability, confirm_appointment, detected_answering_machine)
- Управление участником сессии
- Все методы, связанные с внутренней логикой агента

### 2. agent/modules/config_manager.py
Отвечает за:
- Загрузку и управление переменными окружения
- Загрузку .env файлов
- Обработку конфигурационных параметров
- Управление глобальными настройками агента
- Предоставляет функции для получения конфигурации для LLM, STT, TTS, VAD и сессии

### 3. agent/modules/prompt_processor.py
Отвечает за:
- Загрузку шаблона промпта из markdown файла
- Подстановку переменных в промпт
- Обработку системного промпта
- Валидацию и форматирование промптов

### 4. agent/modules/call_controller.py
Отвечает за:
- Управление завершением вызовов
- Передачу вызовов
- Обработку различных сценариев завершения вызова
- Состояния вызовов
- Проверку фраз прощания

### 5. agent/modules/sip_data_handler.py
Отвечает за:
- Обработку SIP-данных
- Извлечение информации о звонящем
- Работу с метаданными SIP-вызовов
- Определение номера телефона из различных источников
- Идентификацию клиентов по номеру телефона

### 6. agent/modules/media_config.py
Отвечает за:
- Настройку параметров STT (Speech-to-Text)
- Настройку параметров TTS (Text-to-Speech)
- Настройку параметров LLM (Large Language Model)
- Создание экземпляров соответствующих сервисов
- Управление прогревом (warmup) моделей
- Настройку обработчика метрик

## Главный файл (agent/elaina-inbound-mango.py)

Файл содержит:
- Только блок `if __name__ == "__main__":`
- Функцию `entrypoint` для LiveKit
- Инициализацию компонентов и запуск сессии
- Обработчики событий сессии

## Преимущества новой архитектуры

1. **Разделение ответственностей**: Каждый модуль имеет четко определенную область ответственности
2. **Легкость тестирования**: Можно легко тестировать каждый модуль отдельно
3. **Поддерживаемость**: При изменении одной области не нужно менять весь файл
4. **Читаемость**: Код легче понимать и анализировать
5. **Соответствие LiveKit**: Сохранение архитектуры LiveKit агента
6. **Минимальный main файл**: Файл агента остается простым и понятным
7. **Повторное использование**: Некоторые модули могут быть переиспользованы в других агентах

## Использование

Для запуска агента используется команда:

```bash
python -m agent.elaina_inbound_mango
```

или с помощью CLI LiveKit:

```bash
livekit-agents --config config.yaml
```

## Интеграция с системой

Агент поддерживает:
- Идентификацию клиентов по номеру телефона
- Обработку фраз прощания
- Интеграцию с системой записи на прием
- Передачу вызовов операторам
- Обработку голосовой почты
- Отслеживание метрик производительности